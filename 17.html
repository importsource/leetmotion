<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LeetCode 17: Letter Combinations Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#151e32',
                            950: '#020617',
                        }
                    },
                    fontFamily: {
                        mono: ['"Fira Code"', 'monospace'],
                        sans: ['"Inter"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #020617; /* slate-950 */
            color: #e2e8f0; /* slate-200 */
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .code-line {
            transition: background-color 0.2s ease;
            border-left: 2px solid transparent;
        }
        .code-line.active {
            background-color: rgba(59, 130, 246, 0.15); /* blue-500/15 */
            border-left: 2px solid #3b82f6;
        }
        
        /* Syntax Highlighting */
        .token-keyword { color: #c678dd; } /* purple */
        .token-type { color: #e5c07b; } /* yellow/orange */
        .token-string { color: #98c379; } /* green */
        .token-number { color: #d19a66; } /* orange */
        .token-comment { color: #5c6370; font-style: italic; } /* grey */
        .token-method { color: #61afef; } /* blue */

        /* Stack Animation */
        .stack-frame {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Tree Node Styles */
        .node circle { transition: all 0.3s ease; }
        .node text { font-family: 'Inter', sans-serif; text-shadow: 0 1px 3px rgba(0,0,0,0.8); }
        .link { transition: all 0.3s ease; }

        .panel-header {
            @apply px-4 py-2 bg-slate-900 border-b border-slate-800 text-xs font-bold text-slate-400 uppercase tracking-wider flex justify-between items-center;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="h-14 bg-slate-900 border-b border-slate-800 flex justify-between items-center px-4 shrink-0 z-50">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-1.5 rounded-lg shadow-lg shadow-blue-900/20">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></svg>
            </div>
            <div>
                <h1 class="text-sm font-bold text-slate-100 tracking-tight">LeetCode 17: Letter Combinations</h1>
            </div>
        </div>
        <a href="https://importsource.github.io/leetmotion/" target="_blank" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-800 hover:bg-slate-750 text-blue-400 text-xs font-medium border border-slate-700 transition-all hover:border-blue-500/50">
            <span>LeetMotion Home</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></svg>
        </a>
    </header>

    <!-- Main Workspace (3 Columns) -->
    <main class="flex-1 flex overflow-hidden">
        
        <!-- Column 1: Source Code (Left) -->
        <section class="w-[500px] flex flex-col border-r border-slate-800 bg-[#0d1117] shrink-0">
            <div class="panel-header">
                <span>Solution.java</span>
                <span class="text-[10px] text-slate-500">Backtracking</span>
            </div>
            <div id="codeContainer" class="flex-1 overflow-y-auto py-4 text-xs font-mono leading-6 text-slate-300">
                <!-- Code injected by JS -->
            </div>
        </section>

        <!-- Column 2: Tree Visualization (Center) -->
        <section class="flex-1 flex flex-col bg-slate-950 relative min-w-[300px]">
            <div class="panel-header bg-slate-900/50 backdrop-blur-sm absolute top-0 w-full z-10 border-none">
                <span>Recursion Tree</span>
                <div class="flex gap-4">
                    <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.5)]"></div> Active</div>
                    <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full bg-emerald-500"></div> Solution</div>
                    <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full bg-slate-700 border border-slate-500"></div> Visited</div>
                </div>
            </div>
            
            <div id="treeContainer" class="flex-1 w-full h-full"></div>
            
            <!-- Result Bar overlay -->
            <div class="absolute bottom-6 left-1/2 -translate-x-1/2 bg-slate-900/90 backdrop-blur border border-slate-700 px-4 py-2 rounded-full shadow-xl flex items-center gap-3 z-20">
                <span class="text-xs font-semibold text-slate-400 uppercase">Combinations Found:</span>
                <div id="resultList" class="flex gap-2 text-sm font-mono text-emerald-400">
                    <span class="text-slate-600 italic text-xs">None yet...</span>
                </div>
            </div>
        </section>

        <!-- Column 3: Memory & Stack (Right) -->
        <section class="w-[350px] flex flex-col border-l border-slate-800 bg-slate-900 shrink-0">
            
            <!-- Top Half: Call Stack -->
            <div class="flex-1 flex flex-col border-b border-slate-800 overflow-hidden">
                <div class="panel-header">
                    <span>Call Stack</span>
                    <span class="text-[10px] px-1.5 py-0.5 rounded bg-slate-800 text-slate-400 border border-slate-700">LIFO</span>
                </div>
                <div id="stackContainer" class="flex-1 overflow-y-auto p-3 flex flex-col-reverse gap-2 bg-[#0b101b]">
                    <!-- Stack frames injected here (flex-col-reverse makes bottom = main) -->
                </div>
            </div>

            <!-- Bottom Half: Local Variables -->
            <div class="h-[40%] flex flex-col bg-slate-850">
                <div class="panel-header">
                    <span>Current Scope Variables</span>
                </div>
                <div id="localsContainer" class="p-4 grid grid-cols-2 gap-x-4 gap-y-3 content-start overflow-y-auto">
                    <!-- Locals injected here -->
                </div>
            </div>
        </section>

    </main>

    <!-- Bottom Controls -->
    <footer class="h-16 bg-slate-900 border-t border-slate-800 flex items-center px-4 gap-4 shrink-0">
        
        <!-- Input -->
        <div class="flex items-center gap-2 mr-4 border-r border-slate-700 pr-4">
            <span class="text-xs font-semibold text-slate-400">DIGITS</span>
            <input type="text" id="inputDigits" value="23" maxlength="4" class="w-16 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm font-mono text-white focus:border-blue-500 focus:outline-none text-center tracking-widest" placeholder="2-9">
        </div>

        <!-- Playback -->
        <div class="flex items-center gap-2">
            <button id="btnReset" class="p-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-colors" title="Reset">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
            </button>
            <button id="btnPrev" class="p-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-colors disabled:opacity-30" title="Step Back">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="19 20 9 12 19 4 19 20"/><line x1="5" x2="5" y1="19" y2="5"/></svg>
            </button>
            <button id="btnPlayPause" class="w-10 h-10 rounded-full bg-blue-600 hover:bg-blue-500 text-white flex items-center justify-center transition-all shadow-lg shadow-blue-900/40">
                <svg id="iconPlay" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                <svg id="iconPause" class="hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="none"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
            </button>
            <button id="btnNext" class="p-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-colors disabled:opacity-30" title="Step Forward">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 4 15 12 5 20 5 4"/><line x1="19" x2="19" y1="5" y2="19"/></svg>
            </button>
        </div>

        <!-- Slider & Status -->
        <div class="flex-1 flex flex-col justify-center mx-4 gap-1">
            <div class="flex justify-between text-[10px] text-slate-500 font-medium uppercase tracking-wider">
                <span id="statusText">Ready</span>
                <span id="stepCounter">0/0</span>
            </div>
            <div class="relative w-full h-1.5 bg-slate-800 rounded-full cursor-pointer group" id="progressBarContainer">
                <div id="progressBar" class="absolute top-0 left-0 h-full bg-blue-500 rounded-full w-0 transition-all duration-200"></div>
                <div class="absolute top-0 left-0 h-full w-full opacity-0 group-hover:opacity-100 bg-white/5 rounded-full transition-opacity"></div>
            </div>
        </div>

        <!-- Speed -->
        <div class="flex items-center gap-2 text-xs text-slate-500 font-medium">
            <span>SPEED</span>
            <select id="speedSelect" class="bg-slate-800 border-none rounded px-2 py-1 text-slate-300 outline-none focus:ring-1 focus:ring-blue-500 cursor-pointer">
                <option value="2000">0.5x</option>
                <option value="1000" selected>1.0x</option>
                <option value="500">2.0x</option>
                <option value="100">Max</option>
            </select>
        </div>
    </footer>

    <script>
        // --- DATA & CONSTANTS ---
        function stripIndent(str) {
            const match = str.match(/^[ \t]*(?=\S)/gm);
            if (!match) return str;
            const indent = Math.min(...match.map(x => x.length));
            const re = new RegExp(`^[ \\t]{${indent}}`, 'gm');
            return str.replace(re, '').trim();
        }

        const RAW_JAVA_CODE = stripIndent(`
class Solution {
    public List<String> letterCombinations(String digits) {
        //record the result
        List<String> combinations=new ArrayList<>();

        if(digits.length()==0){
            return combinations;
        }

        /***
        **
        There are two main steps:
        1.map the digit to letters.
        2.back track.
        ***/
        Map<Character,String> map=new HashMap<>();
        map.put('2',"abc");
        map.put('3',"def");
        map.put('4',"ghi");
        map.put('5',"jkl");
        map.put('6',"mno");
        map.put('7',"pqrs");
        map.put('8',"tuv");
        map.put('9',"wxyz");

        //the core of core
        backtrack(combinations,map,digits,0,new StringBuilder());

        return combinations;
        
    }

    void backtrack(List<String> combinations,Map<Character,String> map,String digits,int index,StringBuilder sb){
        //back track
        if(index==digits.length()){
            //if index equals digits.length,indicate that the stringbuilder complete,then we need
            //to add the string to result list.
            combinations.add(sb.toString());//'ad' return.
        }else{
            //number
            char digit=digits.charAt(index);
            //the conresponding letters of the specific number
            String letters=map.get(digit);
            //length of the letters string.eg.2:abc 3:def
            int letterscount=letters.length();

            //lettersï¼šabc. second backTrack invocation would handle the 'def'.
            for(int i=0;i<letterscount;i++){
                //append a.   second invocation would handle 'd'
                sb.append(letters.charAt(i));
                //index+1, and then stringbuilder will append 'def', to 'ad','ae','af'.
                backtrack(combinations,map,digits,index+1,sb);
                //when come here, indicate the first pair were complated,so you need to recover the stringbuild status
                //to the previous state which it only have 'a'.
                sb.deleteCharAt(index);
                
            }
        }
    }
}`);

        const PHONE_MAP = {
            '2': 'abc', '3': 'def', '4': 'ghi', '5': 'jkl',
            '6': 'mno', '7': 'pqrs', '8': 'tuv', '9': 'wxyz'
        };

        // --- STATE MANAGEMENT ---
        let state = {
            input: "23",
            steps: [],
            currentStep: 0,
            isPlaying: false,
            timer: null,
            speed: 1000,
            debounce: null
        };

        // --- EXECUTION TRACER (THE BRAIN) ---
        function generateSteps(digits) {
            const steps = [];
            const combinations = [];
            let tree = { id: 'root', val: '""', children: [], status: 'pending' };

            const capture = (line, description, stack, activeNodeId = null) => {
                const cloneNode = (node) => {
                    const newNode = { ...node, children: node.children.map(cloneNode) };
                    if (newNode.status === 'active') newNode.status = 'visited';
                    if (newNode.id === activeNodeId) newNode.status = 'active';
                    return newNode;
                };
                
                const updateSolution = (node) => {
                   if (node.id === activeNodeId && description.includes("Add to combinations")) {
                       node.isSolution = true;
                   }
                   node.children.forEach(updateSolution);
                };

                const currentTree = cloneNode(tree);
                if (activeNodeId) updateSolution(currentTree);

                steps.push({
                    line,
                    description,
                    combinations: [...combinations],
                    stack: JSON.parse(JSON.stringify(stack)),
                    tree: currentTree,
                    activeNodeId
                });
            };

            const stack = [];
            
            if (digits.length === 0) {
                capture(6, "Input empty: check length", stack);
                capture(7, "Return empty list", stack);
                return steps;
            }

            capture(4, "Initialize combinations list", stack);
            capture(16, "Initialize Map mappings", stack);
            // In a real execution this happens step by step, here we just jump to the call
            
            const initialSb = "";
            stack.push({ 
                name: 'backtrack', 
                args: { index: 0, sb: '""' }, 
                locals: {} 
            });
            capture(27, "Initial call to backtrack()", stack, 'root');

            const backtrack = (index, currentSb, parentId) => {
                const nodeId = parentId ? `${parentId}-${currentSb}` : 'root';
                
                const currentFrame = stack[stack.length - 1];
                currentFrame.locals = { index, sb: `"${currentSb}"` };

                capture(33, `Enter backtrack(index=${index}, sb="${currentSb}")`, stack, nodeId);

                capture(35, `Check if index (${index}) == length (${digits.length})`, stack, nodeId);
                if (index === digits.length) {
                    combinations.push(currentSb);
                    
                    const markSol = (n) => {
                        if (n.id === nodeId) n.isSolution = true;
                        n.children.forEach(markSol);
                    };
                    markSol(tree);

                    capture(38, `Base case reached. Add "${currentSb}" to results.`, stack, nodeId);
                    return;
                }

                const digit = digits[index];
                const letters = PHONE_MAP[digit];
                currentFrame.locals = { ...currentFrame.locals, digit: `'${digit}'` };
                capture(41, `Get digit at index ${index}: '${digit}'`, stack, nodeId);
                
                currentFrame.locals = { ...currentFrame.locals, letters: `"${letters}"` };
                capture(43, `Get mapped letters: "${letters}"`, stack, nodeId);
                
                const count = letters.length;
                currentFrame.locals = { ...currentFrame.locals, letterscount: count };
                capture(45, `Get letter count: ${count}`, stack, nodeId);

                for (let i = 0; i < count; i++) {
                    const char = letters[i];
                    currentFrame.locals = { ...currentFrame.locals, i, char: `'${char}'` };
                    
                    capture(48, `Loop i=${i}: Process letter '${char}'`, stack, nodeId);

                    const nextSb = currentSb + char;
                    const childId = `${nodeId}-${nextSb}`;

                    const addChild = (n) => {
                        if (n.id === nodeId) {
                            if (!n.children.find(c => c.id === childId)) {
                                n.children.push({ id: childId, val: nextSb, children: [], status: 'pending' });
                            }
                        }
                        n.children.forEach(addChild);
                    };
                    addChild(tree);

                    capture(50, `sb.append('${char}') -> sb is now "${nextSb}"`, stack, nodeId);

                    stack.push({
                        name: 'backtrack',
                        args: { index: index + 1, sb: `"${nextSb}"` },
                        locals: {}
                    });
                    
                    capture(52, `Recursive Call: backtrack(index=${index+1}, sb="${nextSb}")`, stack, childId);
                    
                    backtrack(index + 1, nextSb, nodeId);

                    stack.pop();
                    capture(52, `Returned to index=${index}, sb="${nextSb}"`, stack, nodeId);

                    capture(55, `sb.deleteCharAt(${index}) -> sb back to "${currentSb}"`, stack, nodeId);
                }
            };

            backtrack(0, "", "");

            capture(29, "All calls finished. Return combinations.", stack, 'root');
            return steps;
        }

        // --- SYNTAX HIGHLIGHTING (ROBUST) ---
        function highlightSyntax(code) {
            const tokens = [];
            const save = (type, content) => {
                tokens.push({type, content});
                return `###TOKEN${tokens.length-1}###`;
            };

            // 1. Hide Strings (both " and ')
            let temp = code.replace(/("(\\.|[^"\\])*"|'(\\.|[^'\\])*')/g, m => save('string', m));
            
            // 2. Hide Comments (Multiline /* ... */ and Single line // ...)
            temp = temp.replace(/(\/\*[\s\S]*?\*\/|\/\/.*$)/gm, m => save('comment', m));
            
            // 3. Escape HTML in the remaining code structure
            temp = temp.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            
            // 4. Highlight Method Definitions (approximate)
            // Matches: Type MethodName(
            temp = temp.replace(/(\b(?:void|String|List(?:&lt;.*?&gt;)?)\b\s+)(\w+)(\s*\()/g, 
                (m, type, name, paren) => `${type}<span class="token-method">${name}</span>${paren}`
            );

            // 5. Highlight Keywords and Types (Single Pass to avoid collision)
            const keywords = new Set(['class', 'public', 'void', 'int', 'return', 'if', 'else', 'for', 'new']);
            const types = new Set(['List', 'String', 'Map', 'HashMap', 'ArrayList', 'StringBuilder', 'Character']);
            
            temp = temp.replace(/\b([a-zA-Z_]\w*)\b|\b([0-9]+)\b/g, (match, word, num) => {
                if (num) return `<span class="token-number">${num}</span>`;
                if (keywords.has(word)) return `<span class="token-keyword">${word}</span>`;
                if (types.has(word)) return `<span class="token-type">${word}</span>`;
                return match;
            });

            // 6. Restore Tokens with HTML Escaping + Span Wrapping
            // Special handling for multi-line comments to allow line splitting
            return temp.replace(/###TOKEN(\d+)###/g, (_, index) => {
                const token = tokens[parseInt(index)];
                const escapedContent = token.content.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                
                if (token.type === 'comment') {
                    // For multi-line comments, we must ensure that if we split by \n later, 
                    // the span is closed and reopened so styles persist across lines.
                    const lines = escapedContent.split('\n');
                    if (lines.length > 1) {
                         return lines.map(line => `<span class="token-comment">${line}</span>`).join('\n');
                    }
                    return `<span class="token-comment">${escapedContent}</span>`;
                }
                if (token.type === 'string') return `<span class="token-string">${escapedContent}</span>`;
                return escapedContent;
            });
        }

        function initCodeView() {
            const container = document.getElementById('codeContainer');
            const lines = RAW_JAVA_CODE.split('\n');
            
            // Highlight the whole block first
            const fullHighlighted = highlightSyntax(RAW_JAVA_CODE);
            const splitHighlighted = fullHighlighted.split('\n');

            container.innerHTML = splitHighlighted.map((codeLine, i) => {
                return `
                <div id="line-${i+1}" class="code-line flex group hover:bg-slate-800/50 cursor-pointer">
                    <span class="w-8 text-right mr-3 text-slate-600 select-none text-[10px] pt-1 opacity-50 group-hover:opacity-100 font-mono">${i+1}</span>
                    <span class="text-content whitespace-pre font-mono text-xs py-0.5">${codeLine || ' '}</span>
                </div>`;
            }).join('');
        }

        function renderCode(lineNumber) {
            document.querySelectorAll('.code-line').forEach(el => el.classList.remove('active'));
            const el = document.getElementById(`line-${lineNumber}`);
            if (el) {
                el.classList.add('active');
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // --- RENDERERS ---

        function renderStack(stack) {
            const container = document.getElementById('stackContainer');
            if (stack.length === 0) {
                container.innerHTML = '<div class="h-full flex items-center justify-center text-slate-600 text-xs italic">Stack is empty</div>';
                return;
            }

            const html = stack.map((frame, i) => {
                const isTop = i === stack.length - 1;
                const activeClass = isTop ? 'border-l-2 border-blue-500 bg-slate-800' : 'border-l-2 border-slate-700 bg-slate-900/50 opacity-60';
                
                const argsStr = Object.entries(frame.args)
                    .map(([k,v]) => `<span class="text-slate-400">${k}:</span><span class="text-amber-200">${v}</span>`)
                    .join(', ');

                return `
                    <div class="stack-frame ${activeClass} p-2 mb-1 rounded-r text-xs font-mono shadow-sm">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold ${isTop ? 'text-blue-300' : 'text-slate-400'}">${frame.name}()</span>
                            ${isTop ? '<span class="text-[9px] bg-blue-900 text-blue-200 px-1 rounded">ACTIVE</span>' : ''}
                        </div>
                        <div class="pl-2 space-x-2 text-[10px]">
                            ${argsStr}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function renderLocals(stack, combinations) {
            const container = document.getElementById('localsContainer');
            const resultList = document.getElementById('resultList');
            
            if (combinations.length === 0) {
                resultList.innerHTML = '<span class="text-slate-600 italic text-xs">None yet...</span>';
            } else {
                resultList.innerHTML = combinations.map(c => 
                    `<span class="bg-emerald-900/30 text-emerald-400 border border-emerald-800/50 px-1.5 rounded text-xs font-mono">"${c}"</span>`
                ).join('');
            }

            if (stack.length === 0) {
                container.innerHTML = '<div class="col-span-2 text-slate-600 text-xs italic">Global scope</div>';
                return;
            }

            const frame = stack[stack.length - 1];
            const locals = frame.locals || {};

            const createVar = (key, val, color) => `
                <div class="bg-slate-900 border border-slate-800 p-2 rounded flex flex-col">
                    <span class="text-[10px] uppercase text-slate-500 font-bold mb-1">${key}</span>
                    <span class="font-mono text-sm ${color} truncate" title="${val}">${val}</span>
                </div>
            `;

            let html = '';
            if (locals.index !== undefined) html += createVar('index', locals.index, 'text-blue-300');
            if (locals.sb !== undefined) html += createVar('sb (Builder)', locals.sb, 'text-amber-300');
            if (locals.digit) html += createVar('digit', locals.digit, 'text-purple-300');
            if (locals.char) html += createVar('char (loop)', locals.char, 'text-pink-300');
            if (locals.letters) html += createVar('letters', locals.letters, 'text-green-300');
            
            container.innerHTML = html;
        }

        // --- D3 TREE VISUALIZER ---
        function renderTree(treeData, activeId) {
            const container = document.getElementById('treeContainer');
            container.innerHTML = '';
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            if (width === 0) return;

            const svg = d3.select(container).append('svg')
                .attr('width', width)
                .attr('height', height)
                .attr('viewBox', `0 0 ${width} ${height}`);

            const g = svg.append('g').attr('transform', `translate(0, 40)`);

            const root = d3.hierarchy(treeData);
            const treeLayout = d3.tree().size([width, height - 80]);
            treeLayout(root);

            g.selectAll('.link')
                .data(root.links())
                .enter().append('path')
                .attr('class', 'link')
                .attr('fill', 'none')
                .attr('stroke', d => {
                    if (findPath(d.target, activeId)) return '#3b82f6';
                    return '#1e293b';
                })
                .attr('stroke-width', d => findPath(d.target, activeId) ? 2 : 1)
                .attr('d', d3.linkVertical().x(d => d.x).y(d => d.y));

            const nodes = g.selectAll('.node')
                .data(root.descendants())
                .enter().append('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${d.x},${d.y})`);

            nodes.append('circle')
                .attr('r', 14)
                .attr('fill', d => {
                    if (d.data.id === activeId) return '#3b82f6';
                    if (d.data.isSolution) return '#10b981';
                    if (d.data.status === 'visited') return '#1e293b';
                    return '#020617';
                })
                .attr('stroke', d => {
                    if (d.data.id === activeId) return '#60a5fa';
                    if (d.data.isSolution) return '#34d399';
                    if (d.data.status === 'visited') return '#475569';
                    return '#334155';
                })
                .attr('stroke-width', d => d.data.id === activeId ? 3 : 2);

            nodes.append('text')
                .attr('dy', 4)
                .attr('text-anchor', 'middle')
                .text(d => {
                     if (d.data.id === 'root') return 'R';
                     return d.data.val.slice(-1);
                })
                .attr('fill', d => {
                    if (d.data.id === activeId || d.data.isSolution) return '#fff';
                    return '#94a3b8';
                })
                .style('font-size', '10px')
                .style('font-weight', 'bold');
            
            nodes.append('text')
                .attr('dy', -20)
                .attr('text-anchor', 'middle')
                .text(d => d.data.val)
                .attr('fill', '#64748b')
                .style('font-size', '9px')
                .style('opacity', d => (d.data.id === activeId || d.data.isSolution) ? 1 : 0);
        }

        function findPath(node, targetId) {
            if (!targetId) return false;
            if (node.data.id === targetId) return true;
            if (node.descendants().some(d => d.data.id === targetId)) return true;
            return false;
        }

        // --- CONTROLLER ---

        function updateUI() {
            if (!state.steps.length) return;
            const step = state.steps[state.currentStep];
            
            document.getElementById('statusText').innerText = step.description;
            document.getElementById('stepCounter').innerText = `${state.currentStep + 1} / ${state.steps.length}`;
            
            const progressPct = ((state.currentStep) / (state.steps.length - 1)) * 100;
            document.getElementById('progressBar').style.width = `${progressPct}%`;
            
            document.getElementById('btnPrev').disabled = state.currentStep === 0;
            document.getElementById('btnNext').disabled = state.currentStep === state.steps.length - 1;

            const playIcon = document.getElementById('iconPlay');
            const pauseIcon = document.getElementById('iconPause');
            if (state.isPlaying) {
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                document.getElementById('btnPlayPause').classList.add('bg-amber-500');
                document.getElementById('btnPlayPause').classList.remove('bg-blue-600');
            } else {
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                document.getElementById('btnPlayPause').classList.remove('bg-amber-500');
                document.getElementById('btnPlayPause').classList.add('bg-blue-600');
            }

            renderCode(step.line);
            renderStack(step.stack);
            renderLocals(step.stack, step.combinations);
            renderTree(step.tree, step.activeNodeId);
        }

        function reset() {
            state.isPlaying = false;
            clearTimeout(state.timer);
            const input = document.getElementById('inputDigits').value.replace(/[^2-9]/g, '').slice(0, 4);
            document.getElementById('inputDigits').value = input;
            state.input = input;
            state.steps = generateSteps(state.input);
            state.currentStep = 0;
            updateUI();
        }

        function step(dir) {
            const next = state.currentStep + dir;
            if (next >= 0 && next < state.steps.length) {
                state.currentStep = next;
                updateUI();
            } else {
                state.isPlaying = false;
                updateUI();
            }
        }

        function playLoop() {
            if (!state.isPlaying) return;
            if (state.currentStep < state.steps.length - 1) {
                state.currentStep++;
                updateUI();
                state.timer = setTimeout(playLoop, state.speed);
            } else {
                state.isPlaying = false;
                updateUI();
            }
        }

        document.getElementById('btnNext').onclick = () => { state.isPlaying = false; step(1); };
        document.getElementById('btnPrev').onclick = () => { state.isPlaying = false; step(-1); };
        document.getElementById('btnReset').onclick = reset;
        
        document.getElementById('btnPlayPause').onclick = () => {
            state.isPlaying = !state.isPlaying;
            if (state.isPlaying) playLoop();
            else clearTimeout(state.timer);
            updateUI();
        };

        document.getElementById('inputDigits'a).oninput = (e) => {
            clearTimeout(state.debounce);
            state.debounce = setTimeout(reset, 300);
        };

        document.getElementById('speedSelect').onchange = (e) => {
            state.speed = parseInt(e.target.value);
        };
        
        document.getElementById('progressBarContainer').onclick = (e) => {
            const rect = e.currentTarget.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const pct = x / rect.width;
            state.currentStep = Math.floor(pct * (state.steps.length - 1));
            state.isPlaying = false;
            updateUI();
        };

        window.addEventListener('resize', () => {
            if (state.steps[state.currentStep]) {
                renderTree(state.steps[state.currentStep].tree, state.steps[state.currentStep].activeNodeId);
            }
        });

        initCodeView();
        reset();

    </script>
</body>
</html>