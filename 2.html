<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LeetCode 2: Add Two Numbers Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              mono: ['Fira Code', 'monospace'],
            },
            colors: {
              lc: {
                dark: '#282c34',
                yellow: '#ffa116',
                gray: '#a8a8a8',
                green: '#5cb85c',
                blue: '#0a84ff',
              }
            }
          }
        }
      }
    </script>
    <style>
      body {
        background-color: #f3f4f6;
      }
      .code-scroll::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      .code-scroll::-webkit-scrollbar-track {
        background: #1e1e1e;
      }
      .code-scroll::-webkit-scrollbar-thumb {
        background: #4a4a4a;
        border-radius: 4px;
      }
      .code-scroll::-webkit-scrollbar-thumb:hover {
        background: #5a5a5a;
      }
      /* Animation classes */
      .node-enter {
        animation: fadeIn 0.3s ease-out;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.8); }
        to { opacity: 1; transform: scale(1); }
      }
      .list-item-transition {
        transition: all 0.3s ease;
      }
    </style>
</head>
<body class="min-h-screen flex flex-col font-sans text-gray-800">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between sticky top-0 z-50">
        <div class="flex items-center gap-4">
            <div class="bg-lc-yellow text-white w-10 h-10 rounded flex items-center justify-center font-bold text-xl">
                <i class="fa-brands fa-js"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-gray-900">Add Two Numbers</h1>
                <p class="text-xs text-gray-500">LeetCode 2 Visualization</p>
            </div>
        </div>
        <div class="flex items-center gap-4 text-sm">
             <a href="https://importsource.github.io/leetmotion/" target="_blank" rel="noreferrer" class="text-blue-600 hover:text-blue-800 font-medium flex items-center gap-2 transition-colors">
                <i class="fa-solid fa-house"></i> LeetMotion Home
             </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 p-4 md:p-6 max-w-[1600px] mx-auto w-full grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <!-- Left Col: Visualization & Controls -->
        <div class="lg:col-span-7 flex flex-col gap-6">
            
            <!-- Input Config -->
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                <div class="flex flex-col md:flex-row gap-4 items-end">
                    <div class="flex-1 w-full">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">List 1 (Comma separated)</label>
                        <input type="text" id="input1" value="2,4,3" class="w-full bg-gray-50 border border-gray-300 rounded px-3 py-2 font-mono focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        <div id="display-l1" class="text-xs text-gray-400 mt-1">Represents: 342</div>
                    </div>
                    <div class="text-2xl text-gray-400 pb-4">+</div>
                    <div class="flex-1 w-full">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">List 2 (Comma separated)</label>
                        <input type="text" id="input2" value="5,6,4" class="w-full bg-gray-50 border border-gray-300 rounded px-3 py-2 font-mono focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        <div id="display-l2" class="text-xs text-gray-400 mt-1">Represents: 465</div>
                    </div>
                    <button id="btn-load" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded font-medium transition-colors">
                        Load
                    </button>
                </div>
            </div>

            <!-- Visualizer Area -->
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200 flex-1 min-h-[400px]">
                <h2 class="text-lg font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <i class="fa-solid fa-eye text-blue-500"></i> Visualization
                </h2>
                <div id="visualizer-container" class="flex flex-col h-full">
                    <!-- Dynamic Content -->
                </div>
            </div>

            <!-- Variable Monitor -->
            <div id="variables-container" class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <!-- Variables Injected Here -->
            </div>

            <!-- Playback Controls -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200 sticky bottom-4 z-40">
                <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                    <div class="flex items-center gap-2 w-full md:w-auto">
                        <button id="btn-reset" class="p-2 text-gray-600 hover:bg-gray-100 rounded disabled:opacity-30 disabled:cursor-not-allowed" title="Reset">
                            <i class="fa-solid fa-rotate-left"></i>
                        </button>
                        <button id="btn-prev" class="p-2 text-gray-600 hover:bg-gray-100 rounded disabled:opacity-30 disabled:cursor-not-allowed" title="Previous Step">
                            <i class="fa-solid fa-backward-step"></i>
                        </button>
                        <button id="btn-play" class="w-12 h-12 rounded-full flex items-center justify-center text-white text-lg transition-transform hover:scale-105 active:scale-95 bg-green-500 hover:bg-green-600">
                            <i id="icon-play" class="fa-solid fa-play pl-1"></i>
                        </button>
                        <button id="btn-next" class="p-2 text-gray-600 hover:bg-gray-100 rounded disabled:opacity-30 disabled:cursor-not-allowed" title="Next Step">
                            <i class="fa-solid fa-forward-step"></i>
                        </button>
                    </div>

                    <div class="flex-1 text-center w-full">
                         <div id="step-counter" class="text-sm font-medium text-gray-500 mb-1">
                            Step 1 of 1
                         </div>
                         <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div id="progress-bar" class="bg-blue-500 h-1.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                         </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold text-gray-400 uppercase">Speed</span>
                        <select id="select-speed" class="bg-gray-100 border-none text-sm rounded py-1 px-2 focus:ring-0 outline-none">
                            <option value="2000">Slow</option>
                            <option value="1000" selected>Normal</option>
                            <option value="500">Fast</option>
                            <option value="100">Turbo</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4 bg-blue-50 text-blue-800 px-4 py-3 rounded text-sm border border-blue-100 flex items-start gap-3">
                    <i class="fa-solid fa-circle-info mt-1 shrink-0"></i>
                    <p id="description-text">Initialized.</p>
                </div>
            </div>

        </div>

        <!-- Right Col: Code -->
        <div class="lg:col-span-5 h-[600px] lg:h-auto lg:sticky lg:top-24 self-start">
            <div class="bg-[#1e1e1e] rounded-lg shadow-xl overflow-hidden border border-gray-700 h-full flex flex-col">
                <div class="px-4 py-2 bg-[#252526] border-b border-gray-700 flex items-center justify-between">
                    <span class="text-gray-300 font-mono text-sm">Solution.java</span>
                </div>
                <div id="code-content" class="p-4 overflow-y-auto font-mono text-sm flex-1 code-scroll">
                    <!-- Code lines injected here -->
                </div>
            </div>
        </div>

    </main>

    <script>
        /**
         * LEETCODE 2: Add Two Numbers
         * Single File Visualizer Implementation
         */

        // --- DATA & CONSTANTS ---
        
        const CODE_SNIPPET = `/**
 * Definition for singly-linked list.
 * public class ListNode {
 *     int val;
 *     ListNode next;
 *     ListNode() {}
 *     ListNode(int val) { this.val = val; }
 *     ListNode(int val, ListNode next) { this.val = val; this.next = next; }
 * }
 */

class Solution {
    public ListNode addTwoNumbers(ListNode l1, ListNode l2) {

        // Create a dummy head node.
        ListNode dummy = new ListNode(0);

        // current is a pointer that will move along the result list.
        ListNode current = dummy;

        // carry stores any carry-over from addition.
        int carry = 0;

        // Continue as long as at least one list still has nodes.
        while (l1 != null || l2 != null) {

            // If l1 still has nodes, take its value; otherwise use 0.
            int x = (l1 != null) ? l1.val : 0;

            // Same for l2: use its value or 0 if it has ended already.
            int y = (l2 != null) ? l2.val : 0;

            // Add the two digits plus the carry from previous step.
            int sum = x + y + carry;

            // Update carry: if sum >= 10, next carry is 1; otherwise 0.
            carry = sum / 10;

            // The digit we store in this node is sum % 10.
            int digit = sum % 10;

            // Create a new node to store the resulting digit.
            current.next = new ListNode(digit);

            // Move the current pointer to the new node.
            current = current.next;

            // Move forward in list l1 if possible.
            if (l1 != null) {
                l1 = l1.next;
            }

            // Same logic for l2: move forward if possible.
            if (l2 != null) {
                l2 = l2.next;
            }
        }

        // After finishing both lists, there may still be a carry.
        if (carry > 0) {
            current.next = new ListNode(carry);
        }

        // Return the real head of the result list.
        return dummy.next;
    }
}`;

        // --- STATE MANAGEMENT ---

        const state = {
            l1: [2, 4, 3],
            l2: [5, 6, 4],
            steps: [],
            currentStepIndex: 0,
            isPlaying: false,
            speed: 1000,
            timer: null
        };

        // --- ALGORITHM LOGIC ---

        function generateSteps(nums1, nums2) {
            const steps = [];

            // Helper to push state snapshot
            const addStep = (line, highlightLines, vars, ptrs, resList, desc) => {
                const lastStep = steps.length > 0 ? steps[steps.length - 1] : null;
                
                steps.push({
                    line,
                    highlightLines,
                    variables: {
                        l1Val: vars.l1Val !== undefined ? vars.l1Val : (lastStep?.variables.l1Val ?? null),
                        l2Val: vars.l2Val !== undefined ? vars.l2Val : (lastStep?.variables.l2Val ?? null),
                        x: vars.x !== undefined ? vars.x : (lastStep?.variables.x ?? null),
                        y: vars.y !== undefined ? vars.y : (lastStep?.variables.y ?? null),
                        carry: vars.carry !== undefined ? vars.carry : (lastStep?.variables.carry ?? 0),
                        sum: vars.sum !== undefined ? vars.sum : (lastStep?.variables.sum ?? null),
                        digit: vars.digit !== undefined ? vars.digit : (lastStep?.variables.digit ?? null),
                    },
                    pointers: {
                        l1Index: ptrs.l1Index !== undefined ? ptrs.l1Index : (lastStep?.pointers.l1Index ?? 0),
                        l2Index: ptrs.l2Index !== undefined ? ptrs.l2Index : (lastStep?.pointers.l2Index ?? 0),
                        resultIndex: ptrs.resultIndex !== undefined ? ptrs.resultIndex : (lastStep?.pointers.resultIndex ?? -1),
                    },
                    resultList: [...resList],
                    description: desc,
                });
            };

            let l1Idx = 0;
            let l2Idx = 0;
            let currentCarry = 0;
            let resultArr = [];

            // Line 16: ListNode dummy = new ListNode(0);
            // Line 19: ListNode current = dummy;
            // Line 22: int carry = 0;
            addStep(16, [16, 19, 22], { carry: 0 }, { resultIndex: -1, l1Index: 0, l2Index: 0 }, [], "Initialize dummy node, current pointer, and carry = 0.");

            while (l1Idx < nums1.length || l2Idx < nums2.length) {
                // Line 25: loop check
                addStep(25, [25], {}, { l1Index: l1Idx, l2Index: l2Idx }, resultArr, `Loop Check: l1 is ${l1Idx < nums1.length ? 'not null' : 'null'}, l2 is ${l2Idx < nums2.length ? 'not null' : 'null'}.`);

                const val1 = l1Idx < nums1.length ? nums1[l1Idx] : null;
                const val2 = l2Idx < nums2.length ? nums2[l2Idx] : null;

                // Line 28: int x
                const x = val1 !== null ? val1 : 0;
                addStep(28, [28], { x, l1Val: val1 }, {}, resultArr, `Read x: l1 is ${val1 !== null ? val1 : 'null'}, so x = ${x}.`);

                // Line 31: int y
                const y = val2 !== null ? val2 : 0;
                addStep(31, [31], { y, l2Val: val2 }, {}, resultArr, `Read y: l2 is ${val2 !== null ? val2 : 'null'}, so y = ${y}.`);

                // Line 34: int sum
                const sum = x + y + currentCarry;
                addStep(34, [34], { sum }, {}, resultArr, `Calculate sum: ${x} + ${y} + ${currentCarry} (carry) = ${sum}.`);

                // Line 37: update carry
                const newCarry = Math.floor(sum / 10);
                addStep(37, [37], { carry: newCarry }, {}, resultArr, `Update carry: ${sum} / 10 = ${newCarry}.`);
                currentCarry = newCarry;

                // Line 40: int digit
                const digit = sum % 10;
                addStep(40, [40], { digit }, {}, resultArr, `Calculate digit: ${sum} % 10 = ${digit}.`);

                // Line 43: current.next = new node
                resultArr = [...resultArr, digit];
                addStep(43, [43], {}, {}, resultArr, `Create new node with value ${digit} and attach to result.`);

                // Line 46: current = current.next
                addStep(46, [46], {}, { resultIndex: resultArr.length - 1 }, resultArr, `Move 'current' pointer forward.`);

                // Line 49-51: Move l1
                if (l1Idx < nums1.length) {
                    l1Idx++;
                    addStep(51, [49, 50, 51], {}, { l1Index: l1Idx }, resultArr, `l1 was not null, move l1 pointer forward.`);
                } else {
                    addStep(49, [49], {}, {}, resultArr, `l1 is null, do not move.`);
                }

                // Line 54-56: Move l2
                if (l2Idx < nums2.length) {
                    l2Idx++;
                    addStep(56, [54, 55, 56], {}, { l2Index: l2Idx }, resultArr, `l2 was not null, move l2 pointer forward.`);
                } else {
                    addStep(54, [54], {}, {}, resultArr, `l2 is null, do not move.`);
                }
            }

            // Loop Exit
            addStep(25, [25], {}, { l1Index: l1Idx, l2Index: l2Idx }, resultArr, `Loop Check: Both l1 and l2 are null. Exit loop.`);

            // Final carry
            if (currentCarry > 0) {
                addStep(60, [60], {}, {}, resultArr, `Check carry: ${currentCarry} > 0.`);
                resultArr = [...resultArr, currentCarry];
                addStep(61, [61], {}, { resultIndex: resultArr.length - 1 }, resultArr, `Append extra carry node ${currentCarry}.`);
            } else {
                addStep(60, [60], {}, {}, resultArr, `Check carry: ${currentCarry} is 0. No extra node needed.`);
            }

            // Return
            addStep(65, [65], {}, {}, resultArr, `Return dummy.next (the result list).`);

            return steps;
        }

        // --- RENDERING HELPERS ---

        function renderSyntaxHighlighting(line) {
            // Simple logic to wrap tokens in spans for styling
            if (line.trim().startsWith('//')) {
                return `<span style="color: #6a9955">${line}</span>`;
            }
            
            const parts = line.split(/(\b(?:public|class|new|int|return|if|while|else|null|this)\b|\/\/.*)/g);
            
            return parts.map(part => {
                if (part.match(/\b(public|class|new|int|return|if|while|else|null)\b/)) {
                    return `<span style="color: #569cd6">${part}</span>`;
                } else if (part.match(/\b(this)\b/)) {
                    return `<span style="color: #569cd6">${part}</span>`;
                } else if (part.startsWith('//')) {
                    return `<span style="color: #6a9955">${part}</span>`;
                } else if (part.match(/\b(ListNode)\b/)) {
                    return `<span style="color: #4ec9b0">${part}</span>`;
                } else if (part.match(/\b(val|next|l1|l2|dummy|current)\b/)) {
                     return `<span style="color: #9cdcfe">${part}</span>`;
                } else if (part.match(/\b(\d+)\b/)) {
                     return `<span style="color: #b5cea8">${part}</span>`;
                }
                return `<span style="color: #d4d4d4">${part}</span>`;
            }).join('');
        }

        function createNodeHtml(val, isActive, label, isNull, isGhost) {
            let containerClass = "relative flex flex-col items-center mx-2 group node-enter";
            
            let labelHtml = label 
                ? `<div class="flex flex-col items-center animate-bounce"><span>${label}</span><i class="fa-solid fa-arrow-down"></i></div>` 
                : `<span>&nbsp;</span>`;

            let circleClass = "w-12 h-12 rounded-full flex items-center justify-center border-2 text-lg font-mono font-bold transition-all duration-300 z-10 ";
            
            if (isNull) {
                circleClass += "border-gray-300 bg-gray-100 text-gray-400 border-dashed";
            } else if (isActive) {
                circleClass += "border-lc-yellow bg-yellow-50 text-lc-yellow shadow-[0_0_15px_rgba(255,161,22,0.5)] scale-110";
            } else if (isGhost) {
                circleClass += "border-gray-200 text-gray-300";
            } else {
                circleClass += "border-gray-400 bg-white text-gray-700";
            }

            return `
                <div class="${containerClass}">
                    <div class="h-6 mb-1 text-xs font-bold text-blue-600 transition-all duration-300 w-full text-center">
                        ${labelHtml}
                    </div>
                    <div class="${circleClass}">
                        ${isNull ? 'null' : val}
                    </div>
                </div>
            `;
        }

        function createListRowHtml(title, nums, activeIndex, pointerLabel, showNull = true) {
            let nodesHtml = nums.map((val, idx) => {
                const isActive = activeIndex === idx;
                const label = isActive ? pointerLabel : null;
                return `
                    ${createNodeHtml(val, isActive, label, false, false)}
                    <div class="text-gray-400 text-xl mx-1"><i class="fa-solid fa-arrow-right"></i></div>
                `;
            }).join('');

            if (showNull) {
                const isNullActive = activeIndex === nums.length;
                nodesHtml += createNodeHtml(null, isNullActive, isNullActive ? pointerLabel : null, true, false);
            }

            return `
                <div class="flex items-center mb-8 bg-gray-50 rounded-lg p-4 border border-gray-200 overflow-x-auto list-item-transition">
                    <div class="w-24 font-bold text-gray-600 shrink-0">${title}</div>
                    <div class="flex items-center min-w-max">
                        ${nodesHtml}
                    </div>
                </div>
            `;
        }

        // --- MAIN RENDER FUNCTION ---

        function render() {
            const currentStep = state.steps[state.currentStepIndex];
            if (!currentStep) return;

            // 1. Render Visualizer
            const visualizerContainer = document.getElementById('visualizer-container');
            
            // Result Row Logic
            let resultNodesHtml = `
                ${createNodeHtml(0, false, state.currentStepIndex === -1 ? 'current' : null, false, true)}
                <div class="text-gray-400 text-xl mx-1"><i class="fa-solid fa-arrow-right"></i></div>
            `;
            
            resultNodesHtml += currentStep.resultList.map((val, idx) => {
                const isActive = currentStep.pointers.resultIndex === idx;
                return `
                    ${createNodeHtml(val, isActive, isActive ? 'current' : null, false, false)}
                    <div class="text-gray-400 text-xl mx-1"><i class="fa-solid fa-arrow-right"></i></div>
                `;
            }).join('');
            
            resultNodesHtml += createNodeHtml(null, false, null, true, false);

            const resultRowHtml = `
                <div class="flex items-center mt-6 bg-green-50 rounded-lg p-4 border border-green-200 overflow-x-auto min-h-[120px] list-item-transition">
                    <div class="w-24 font-bold text-green-700 shrink-0">Result</div>
                    <div class="flex items-center min-w-max">
                        ${resultNodesHtml}
                    </div>
                </div>
            `;

            visualizerContainer.innerHTML = `
                ${createListRowHtml('List 1 (l1)', state.l1, currentStep.pointers.l1Index, 'l1')}
                ${createListRowHtml('List 2 (l2)', state.l2, currentStep.pointers.l2Index, 'l2')}
                <div class="my-2 border-t border-dashed border-gray-300"></div>
                ${resultRowHtml}
            `;

            // 2. Render Variables
            const varsContainer = document.getElementById('variables-container');
            const vars = ['x', 'y', 'sum', 'carry', 'digit'];
            varsContainer.innerHTML = vars.map(name => {
                const val = currentStep.variables[name];
                const prevStep = state.currentStepIndex > 0 ? state.steps[state.currentStepIndex - 1] : null;
                const changed = prevStep && prevStep.variables[name] !== val;
                
                return `
                <div class="bg-white rounded p-3 shadow-sm border border-gray-200 flex flex-col items-center min-w-[80px]">
                    <span class="text-xs text-gray-500 font-semibold uppercase mb-1">${name}</span>
                    <span class="text-xl font-mono font-bold ${changed ? 'text-lc-yellow' : 'text-gray-800'}">
                    ${val === null || val === undefined ? 'null' : val}
                    </span>
                </div>
                `;
            }).join('');

            // 3. Render Controls Info
            document.getElementById('step-counter').innerText = `Step ${state.currentStepIndex + 1} of ${state.steps.length}`;
            const progress = ((state.currentStepIndex + 1) / state.steps.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('description-text').innerText = currentStep.description;

            // 4. Update Button States
            const resetBtn = document.getElementById('btn-reset');
            const prevBtn = document.getElementById('btn-prev');
            const nextBtn = document.getElementById('btn-next');
            
            resetBtn.disabled = state.currentStepIndex === 0;
            prevBtn.disabled = state.currentStepIndex === 0;
            nextBtn.disabled = state.currentStepIndex === state.steps.length - 1;

            // Add/Remove opacity classes manually since disabled attribute handles pointer events but styles need help in plain JS updates sometimes depending on tailwind setup
            [resetBtn, prevBtn, nextBtn].forEach(btn => {
                if (btn.disabled) btn.classList.add('opacity-30');
                else btn.classList.remove('opacity-30');
            });
            
            const playBtn = document.getElementById('btn-play');
            const playIcon = document.getElementById('icon-play');
            if (state.isPlaying) {
                playBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                playBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                playIcon.classList.remove('fa-play', 'pl-1');
                playIcon.classList.add('fa-pause');
            } else {
                playBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                playBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                playIcon.classList.remove('fa-pause');
                playIcon.classList.add('fa-play', 'pl-1');
            }

            // 5. Update Code Highlights
            const codeLines = document.querySelectorAll('.code-line');
            codeLines.forEach(line => {
                const lineNum = parseInt(line.dataset.line);
                line.classList.remove('bg-[#37373d]', 'bg-[#2c2c30]');
                
                if (lineNum === currentStep.line) {
                    line.classList.add('bg-[#37373d]');
                    // Scroll logic
                    const container = document.getElementById('code-content');
                    const containerRect = container.getBoundingClientRect();
                    const lineRect = line.getBoundingClientRect();
                    if (lineRect.bottom > containerRect.bottom || lineRect.top < containerRect.top) {
                        line.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                } else if (currentStep.highlightLines.includes(lineNum)) {
                    line.classList.add('bg-[#2c2c30]');
                }
            });
        }

        // --- INITIALIZATION ---

        function initCodeViewer() {
            const container = document.getElementById('code-content');
            const lines = CODE_SNIPPET.split('\n');
            container.innerHTML = lines.map((content, idx) => {
                const lineNum = idx + 1;
                return `
                    <div class="flex leading-6 code-line" data-line="${lineNum}">
                        <div class="w-8 text-gray-500 text-right mr-4 select-none shrink-0">${lineNum}</div>
                        <div class="text-gray-300 whitespace-pre">${renderSyntaxHighlighting(content)}</div>
                    </div>
                `;
            }).join('');
        }

        function updateInputsDisplay() {
            const revL1 = [...state.l1].reverse().join('');
            const revL2 = [...state.l2].reverse().join('');
            document.getElementById('display-l1').innerText = `Represents: ${revL1}`;
            document.getElementById('display-l2').innerText = `Represents: ${revL2}`;
        }

        function loadData() {
            const val1 = document.getElementById('input1').value;
            const val2 = document.getElementById('input2').value;
            
            const parse = (str) => str.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
            
            state.l1 = parse(val1);
            state.l2 = parse(val2);
            state.steps = generateSteps(state.l1, state.l2);
            state.currentStepIndex = 0;
            state.isPlaying = false;
            if (state.timer) clearInterval(state.timer);
            
            updateInputsDisplay();
            render();
        }

        // --- EVENT LISTENERS ---

        document.getElementById('btn-load').addEventListener('click', loadData);

        document.getElementById('input1').addEventListener('input', (e) => {
             const arr = e.target.value.split(',').map(s=>s.trim());
             const numStr = arr.slice().reverse().join('');
             document.getElementById('display-l1').innerText = `Represents: ${numStr}`;
        });
         document.getElementById('input2').addEventListener('input', (e) => {
             const arr = e.target.value.split(',').map(s=>s.trim());
             const numStr = arr.slice().reverse().join('');
             document.getElementById('display-l2').innerText = `Represents: ${numStr}`;
        });

        document.getElementById('btn-reset').addEventListener('click', () => {
            state.isPlaying = false;
            if (state.timer) clearInterval(state.timer);
            state.currentStepIndex = 0;
            render();
        });

        document.getElementById('btn-prev').addEventListener('click', () => {
            state.isPlaying = false;
            if (state.timer) clearInterval(state.timer);
            if (state.currentStepIndex > 0) {
                state.currentStepIndex--;
                render();
            }
        });

        document.getElementById('btn-next').addEventListener('click', () => {
            state.isPlaying = false;
            if (state.timer) clearInterval(state.timer);
            if (state.currentStepIndex < state.steps.length - 1) {
                state.currentStepIndex++;
                render();
            }
        });

        document.getElementById('btn-play').addEventListener('click', () => {
            state.isPlaying = !state.isPlaying;
            
            if (state.isPlaying) {
                // If at end, reset first
                if (state.currentStepIndex === state.steps.length - 1) {
                    state.currentStepIndex = 0;
                }
                
                render(); // update UI to Pause icon
                
                if (state.timer) clearInterval(state.timer);
                state.timer = setInterval(() => {
                    if (state.currentStepIndex < state.steps.length - 1) {
                        state.currentStepIndex++;
                        render();
                    } else {
                        state.isPlaying = false;
                        clearInterval(state.timer);
                        render();
                    }
                }, state.speed);
            } else {
                if (state.timer) clearInterval(state.timer);
                render(); // update UI to Play icon
            }
        });

        document.getElementById('select-speed').addEventListener('change', (e) => {
            state.speed = parseInt(e.target.value);
            if (state.isPlaying) {
                // restart timer with new speed
                clearInterval(state.timer);
                state.timer = setInterval(() => {
                    if (state.currentStepIndex < state.steps.length - 1) {
                        state.currentStepIndex++;
                        render();
                    } else {
                        state.isPlaying = false;
                        clearInterval(state.timer);
                        render();
                    }
                }, state.speed);
            }
        });

        // --- STARTUP ---
        window.addEventListener('DOMContentLoaded', () => {
            initCodeViewer();
            loadData();
        });

    </script>
</body>
</html>